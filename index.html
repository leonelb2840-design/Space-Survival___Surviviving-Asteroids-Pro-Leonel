<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Asteroids Survival PRO - Nuclear y Megabomb FIXED</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  body { margin:0; padding:0; background:#000; overflow:hidden; touch-action:none; font-family:Arial,sans-serif; }
  canvas { display:block; touch-action:none; }
  #start { position:absolute; inset:0; background:rgba(0,0,0,0.8); color:#0f0; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; z-index:10; font-size:24px; }
  #gameover { position:absolute; inset:0; background:rgba(0,0,0,0.9); color:#f44; display:none; flex-direction:column; align-items:center; justify-content:center; z-index:10; font-size:32px; }
  #ui { position:absolute; top:10px; left:10px; color:white; font-size:18px; pointer-events:none; z-index:5; }
  button { margin-top:20px; padding:15px 40px; font-size:22px; background:#222; color:white; border:2px solid #0f0; cursor:pointer; }
</style>
</head>
<body>

<div id="ui">
  Puntos: <span id="score">0</span><br>
  Vida: <span id="lives">3</span><br>
  Asteroides: <span id="astCount">0</span><br>
  Boss: <span id="bossHP">0</span>
</div>

<div id="start">
  <h1>Asteroids Survival PRO</h1>
  <p>¡Toca la pantalla para empezar!</p>
  <p>Arrastra para mover • Toca para disparar</p>
  <p>Megabomb (naranja): toque largo • Nuclear (rojo): auto al recoger</p>
  <button onclick="startGame()">JUGAR</button>
</div>

<div id="gameover">
  GAME OVER<br>
  Puntos: <span id="final">0</span><br>
  <button onclick="location.reload()">Jugar de nuevo</button>
</div>

<canvas id="c"></canvas>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const startDiv = document.getElementById('start');
const goDiv = document.getElementById('gameover');
const scoreEl = document.getElementById('score');
const livesEl = document.getElementById('lives');
const astCountEl = document.getElementById('astCount');
const bossHPEl = document.getElementById('bossHP');
const finalEl = document.getElementById('final');

let w, h;
function resize() {
  w = canvas.width = window.innerWidth;
  h = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

let running = false;
let score = 0;
let lives = 3;
let bossActive = false;
let bossHP = 0;

const ship = {
  x: w/2, y: h/2,
  angle: -Math.PI/2,
  radius: 15,
  powerup: null,
  powerupTime: 0,
  touchStartTime: 0  // para megabomb toque largo
};

let asteroids = [];
let bullets = [];
let powerups = [];
let particles = [];

let touchActive = false;
let touchX = 0, touchY = 0;
let lastShot = 0;

function startGame() {
  startDiv.style.display = 'none';
  running = true;
  score = 0;
  lives = 3;
  bossActive = false;
  bossHP = 0;
  ship.x = w/2;
  ship.y = h/2;
  ship.powerup = null;
  ship.powerupTime = 0;
  asteroids = [];
  bullets = [];
  powerups = [];
  particles = [];
  spawnAsteroides(5);
  loop();
}

function spawnAsteroides(count, size = 'large') {
  for (let i = 0; i < count; i++) {
    let side = Math.floor(Math.random()*4);
    let x, y;
    if (side === 0) { x = Math.random()*w; y = -50; }
    else if (side === 1) { x = w+50; y = Math.random()*h; }
    else if (side === 2) { x = Math.random()*w; y = h+50; }
    else { x = -50; y = Math.random()*h; }

    asteroids.push({
      x, y,
      vx: (Math.random()-0.5)*2.8,
      vy: (Math.random()-0.5)*2.8,
      size: size === 'large' ? 35 + Math.random()*30 : size === 'med' ? 20 + Math.random()*15 : 10 + Math.random()*8,
      type: size,
      angle: Math.random()*Math.PI*2,
      rotSpeed: (Math.random()-0.5)*0.05
    });
  }
}

function spawnBoss() {
  bossActive = true;
  bossHP = 80 + Math.floor(score / 1000);
  asteroids.push({
    x: w/2, y: -100,
    vx: 0, vy: 1.2,
    size: 80,
    type: 'boss',
    hp: bossHP,
    angle: 0,
    rotSpeed: 0.02,
    shootTimer: 0
  });
}

// Touch controls
canvas.addEventListener('touchstart', e => {
  e.preventDefault();
  if (!running) { startGame(); return; }
  touchActive = true;
  const t = e.touches[0];
  touchX = t.clientX;
  touchY = t.clientY;
  ship.touchStartTime = Date.now(); // para toque largo megabomb
  fire();
}, {passive: false});

canvas.addEventListener('touchmove', e => {
  e.preventDefault();
  if (!touchActive) return;
  const t = e.touches[0];
  const dx = t.clientX - touchX;
  const dy = t.clientY - touchY;
  ship.x += dx * 0.8;
  ship.y += dy * 0.8;
  touchX = t.clientX;
  touchY = t.clientY;
}, {passive: false});

canvas.addEventListener('touchend', e => {
  e.preventDefault();
  touchActive = false;
  const touchDuration = Date.now() - ship.touchStartTime;

  // Megabomb: toque largo > 800ms
  if (ship.powerup === 'megabomb' && touchDuration > 800) {
    triggerMegabomb();
  }

  ship.touchStartTime = 0;
}, {passive: false});

canvas.addEventListener('click', e => {
  if (!running) { startGame(); return; }
  fire();
});

function triggerMegabomb() {
  // Explosión radial
  for (let i = asteroids.length - 1; i >= 0; i--) {
    const a = asteroids[i];
    if (Math.hypot(ship.x - a.x, ship.y - a.y) < 200) {
      asteroids.splice(i, 1);
      score += Math.floor(a.size * 3);
      // partículas explosión
      for (let k = 0; k < 30; k++) {
        particles.push({
          x: a.x, y: a.y,
          vx: (Math.random()-0.5)*12,
          vy: (Math.random()-0.5)*12,
          life: 50
        });
      }
    }
  }
  // Flash naranja
  ctx.fillStyle = 'rgba(255,136,0,0.6)';
  ctx.fillRect(0,0,w,h);
}

function fire() {
  const now = Date.now();
  if (now - lastShot < (ship.powerup === 'rapid' ? 80 : 200)) return;
  lastShot = now;

  let numBullets = ship.powerup === 'multi' ? 3 : 1;
  let spread = ship.powerup === 'multi' ? 0.3 : 0;

  for (let i = 0; i < numBullets; i++) {
    let a = ship.angle + (i - (numBullets-1)/2) * spread;
    bullets.push({
      x: ship.x,
      y: ship.y,
      vx: Math.cos(a) * 12,
      vy: Math.sin(a) * 12,
      life: 90
    });
  }
}

function loop() {
  if (!running) return requestAnimationFrame(loop);

  ctx.fillStyle = 'rgba(0,5,15,0.18)';
  ctx.fillRect(0,0,w,h);

  ship.x = (ship.x + w) % w;
  ship.y = (ship.y + h) % h;
  if (ship.powerupTime > 0) ship.powerupTime--;
  else ship.powerup = null;

  // Nave con glow
  ctx.save();
  ctx.translate(ship.x, ship.y);
  ctx.rotate(ship.angle);

  let shipColor = '#0ff';
  let glowColor = null;
  let glowStrength = 0;

  switch (ship.powerup) {
    case 'shield': shipColor = '#dbfffe'; glowColor = '#dbfffe'; glowStrength = 25; break;
    case 'rapid': shipColor = '#ffff00'; glowColor = '#ffff00'; glowStrength = 30; break;
    case 'multi': shipColor = '#ff00ff'; glowColor = '#ff00ff'; glowStrength = 30; break;
    case 'megabomb': shipColor = '#ff8800'; glowColor = '#ff8800'; glowStrength = 25; break;
    case 'timeslow': shipColor = '#aa00ff'; glowColor = '#aa00ff'; glowStrength = 25; break;
    case 'magnet': shipColor = '#00aaff'; glowColor = '#00aaff'; glowStrength = 25; break;
    case 'laser': shipColor = '#00ff00'; glowColor = '#00ff00'; glowStrength = 25; break;
  }

  ctx.fillStyle = shipColor;
  ctx.strokeStyle = '#fff';
  ctx.lineWidth = 2;
  ctx.shadowBlur = glowStrength;
  ctx.shadowColor = glowColor || '#0ff';

  ctx.beginPath();
  ctx.moveTo(22, 0);
  ctx.lineTo(-12, 12);
  ctx.lineTo(-5, 0);
  ctx.lineTo(-12, -12);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  ctx.shadowBlur = 0;
  ctx.restore();

  // Spawn asteroides
  const maxAst = 18 + Math.floor(score / 1500);
  if (asteroids.length < maxAst && Math.random() < 0.008 + score / 150000) {
    spawnAsteroides(1);
  }

  // Boss cada 1500
  if (score > 0 && score % 1500 === 0 && !bossActive) {
    spawnBoss();
  }

  // Update asteroides
  for (let i = asteroids.length - 1; i >= 0; i--) {
    const a = asteroids[i];
    let speedMult = 1;
    if (ship.powerup === 'timeslow') speedMult = 0.4;

    a.x += a.vx * speedMult;
    a.y += a.vy * speedMult;
    a.angle += a.rotSpeed;

    a.vx += (Math.random() - 0.5) * 0.015;
    a.vy += (Math.random() - 0.5) * 0.015;

    if (a.x < -a.size) a.x = w + a.size;
    if (a.x > w + a.size) a.x = -a.size;
    if (a.y < -a.size) a.y = h + a.size;
    if (a.y > h + a.size) a.y = -a.size;

    if (a.type === 'boss') {
      a.shootTimer = (a.shootTimer || 0) + 1;
      if (a.shootTimer > 90) {
        const dx = ship.x - a.x;
        const dy = ship.y - a.y;
        const dist = Math.hypot(dx, dy);
        bullets.push({
          x: a.x, y: a.y,
          vx: (dx / dist) * 6,
          vy: (dy / dist) * 6,
          life: 120,
          enemy: true
        });
        a.shootTimer = 0;
      }
    }

    ctx.save();
    ctx.translate(a.x, a.y);
    ctx.rotate(a.angle);
    ctx.strokeStyle = a.type === 'boss' ? '#f0f' : '#ccc';
    ctx.lineWidth = a.type === 'boss' ? 4 : 3;
    ctx.fillStyle = a.type === 'boss' ? 'rgba(255,0,255,0.2)' : 'transparent';
    ctx.shadowColor = a.type === 'boss' ? '#f0f' : '#ccc';
    ctx.shadowBlur = a.type === 'boss' ? 15 : 0;
    ctx.beginPath();
    ctx.arc(0, 0, a.size, 0, Math.PI*2);
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(a.size*0.9, 0);
    for (let j = 1; j < 12; j++) {
      let r = a.size * (0.5 + Math.random()*0.5);
      let ang = j * Math.PI*2 / 12;
      ctx.lineTo(Math.cos(ang)*r, Math.sin(ang)*r);
    }
    ctx.closePath();
    ctx.stroke();
    ctx.restore();

    if (a.type === 'boss') {
      const barW = a.size * 1.8;
      ctx.fillStyle = 'rgba(0,0,0,0.7)';
      ctx.fillRect(a.x - barW/2, a.y - a.size - 15, barW, 8);
      ctx.fillStyle = '#0f0';
      ctx.fillRect(a.x - barW/2, a.y - a.size - 15, barW * (a.hp / bossHP), 8);
      bossHPEl.textContent = a.hp;
    }

    let dist = Math.hypot(ship.x - a.x, ship.y - a.y);
    if (dist < a.size + 20 && ship.powerup !== 'shield') {
      lives--;
      livesEl.textContent = lives;
      asteroids.splice(i, 1);
      if (lives <= 0) {
        running = false;
        finalEl.textContent = score;
        goDiv.style.display = 'flex';
        return;
      }
    }

    if (ship.powerup === 'magnet') {
      let dx = ship.x - a.x;
      let dy = ship.y - a.y;
      let distToShip = Math.hypot(dx, dy);
      if (distToShip < 300) {
        a.vx += dx / distToShip * 0.5;
        a.vy += dy / distToShip * 0.5;
      }
    }
  }

  // Balas jugador
  for (let i = bullets.length - 1; i >= 0; i--) {
    const b = bullets[i];
    if (b.enemy) {
      b.x += b.vx;
      b.y += b.vy;
      b.life--;
      ctx.fillStyle = '#f44';
      ctx.shadowColor = '#f44';
      ctx.shadowBlur = 15;
      ctx.fillRect(b.x-3, b.y-3, 6, 6);
      ctx.shadowBlur = 0;
      if (b.life <= 0 || b.x < 0 || b.x > w || b.y < 0 || b.y > h) {
        bullets.splice(i, 1);
        continue;
      }
      if (Math.hypot(ship.x - b.x, ship.y - b.y) < 20 && ship.powerup !== 'shield') {
        lives--;
        livesEl.textContent = lives;
        bullets.splice(i, 1);
        if (lives <= 0) {
          running = false;
          finalEl.textContent = score;
          goDiv.style.display = 'flex';
          return;
        }
      }
      continue;
    }

    b.x += b.vx;
    b.y += b.vy;
    b.life--;
    ctx.fillStyle = '#ff0';
    ctx.shadowBlur = 12;
    ctx.shadowColor = '#ff0';
    ctx.fillRect(b.x-3, b.y-3, 6, 6);
    ctx.shadowBlur = 0;

    if (b.life <= 0 || b.x < -50 || b.x > w+50 || b.y < -50 || b.y > h+50) {
      bullets.splice(i, 1);
      continue;
    }

    for (let j = asteroids.length - 1; j >= 0; j--) {
      const a = asteroids[j];
      if (Math.hypot(b.x - a.x, b.y - a.y) < a.size) {
        a.hp = (a.hp || 1) - 1;
        bullets.splice(i, 1);

        if (a.hp <= 0) {
          let pts = Math.floor(a.size * 2);
          if (a.type === 'boss') pts *= 10;
          score += pts;
          scoreEl.textContent = score;

          if (a.type !== 'boss') {
            if (a.type === 'large') spawnAsteroides(2, 'med');
            else if (a.type === 'med') spawnAsteroides(3, 'small');
          } else {
            bossActive = false;
            bossHPEl.textContent = 0;
          }

          if (Math.random() < 0.4) {
            const types = ['multi', 'rapid', 'shield', 'megabomb', 'timeslow', 'magnet', 'laser', 'nuclear'];
            powerups.push({
              x: a.x, y: a.y,
              type: types[Math.floor(Math.random()*types.length)],
              vy: 1,
              life: 600
            });
          }

          for (let k = 0; k < 15; k++) {
            particles.push({
              x: a.x, y: a.y,
              vx: (Math.random()-0.5)*8,
              vy: (Math.random()-0.5)*8,
              life: 40
            });
          }

          asteroids.splice(j, 1);
        }
        break;
      }
    }
  }

  // Power-ups
  for (let i = powerups.length - 1; i >= 0; i--) {
    const p = powerups[i];
    p.y += p.vy;
    p.life--;
    p.x += Math.sin(Date.now() * 0.01 + i) * 0.5;

    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.fillStyle = p.type === 'multi' ? '#ff00ff' :
                    p.type === 'rapid' ? '#ffff00' :
                    p.type === 'shield' ? '#dbfffe' :
                    p.type === 'megabomb' ? '#ff8800' :
                    p.type === 'timeslow' ? '#aa00ff' :
                    p.type === 'magnet' ? '#00aaff' :
                    p.type === 'laser' ? '#00ff00' :
                    p.type === 'nuclear' ? '#ff0000' : '#fff';
    ctx.shadowBlur = 25;
    ctx.shadowColor = ctx.fillStyle;
    ctx.beginPath();
    ctx.arc(0, 0, 12, 0, Math.PI*2);
    ctx.fill();
    ctx.shadowBlur = 0;
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.restore();

    if (Math.hypot(ship.x - p.x, ship.y - p.y) < 25) {
      ship.powerup = p.type;
      ship.powerupTime = 600;

      // Efectos inmediatos
      if (p.type === 'nuclear') {
        triggerNuclear();
      }

      powerups.splice(i, 1);
    } else if (p.life <= 0 || p.y > h) {
      powerups.splice(i, 1);
    }
  }

  // Efecto Laser
  if (ship.powerup === 'laser' && touchActive) {
    ctx.beginPath();
    ctx.moveTo(ship.x, ship.y);
    ctx.lineTo(touchX, touchY);
    ctx.strokeStyle = '#00ff00';
    ctx.lineWidth = 5;
    ctx.shadowBlur = 20;
    ctx.shadowColor = '#00ff00';
    ctx.stroke();
    ctx.shadowBlur = 0;

    // Daño continuo
    for (let i = asteroids.length - 1; i >= 0; i--) {
      const a = asteroids[i];
      let distToLine = Math.abs((touchY - ship.y) * (a.x - ship.x) - (touchX - ship.x) * (a.y - ship.y)) / Math.hypot(touchX - ship.x, touchY - ship.y);
      if (distToLine < a.size + 10) {
        a.hp = (a.hp || 1) - 0.5;
        if (a.hp <= 0) {
          score += Math.floor(a.size * 2);
          scoreEl.textContent = score;
          asteroids.splice(i, 1);
        }
      }
    }
  }

  // Particles
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.life--;
    p.vx *= 0.95;
    p.vy *= 0.95;
    ctx.globalAlpha = p.life / 40;
    ctx.fillStyle = '#ffaa00';
    ctx.fillRect(p.x-2, p.y-2, 4, 4);
    ctx.globalAlpha = 1;
    if (p.life <= 0) particles.splice(i, 1);
  }

  astCountEl.textContent = asteroids.filter(a => a.type !== 'boss').length;

  requestAnimationFrame(loop);
}

function triggerNuclear() {
  // Flash rojo + partículas
  ctx.fillStyle = 'rgba(255,0,0,0.7)';
  ctx.fillRect(0,0,w,h);

  for (let k = 0; k < 80; k++) {
    particles.push({
      x: ship.x, y: ship.y,
      vx: (Math.random()-0.5)*15,
      vy: (Math.random()-0.5)*15,
      life: 80
    });
  }

  // Destruye todos
  asteroids = [];

  // Vuelven después de 1s
  setTimeout(() => {
    if (running) spawnAsteroides(8, 'large');
  }, 1000);
}
</script>
</body>
</html>
